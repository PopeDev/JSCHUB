@inherits LayoutComponentBase
@implements IDisposable
@using JSCHUB.Application.Interfaces
@inject ICurrentUserService CurrentUser
@inject IAuthService AuthService
@inject NavigationManager Navigation

<MudThemeProvider @ref="_themeProvider" @bind-IsDarkMode="_isDarkMode" Theme="_customTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Dense="true">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
                       OnClick="@(() => _drawerOpen = !_drawerOpen)" />
        <MudText Typo="Typo.h6" Class="ml-2">JSCHUB</MudText>
        <MudSpacer />

        @if (CurrentUser.IsAuthenticated)
        {
            <MudText Typo="Typo.body2" Class="mr-3">
                <strong>@CurrentUser.CurrentUserName</strong>
            </MudText>
            <MudButton Variant="Variant.Text" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.Logout"
                       OnClick="HandleLogout" Size="Size.Small">
                Salir
            </MudButton>
        }

        <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                       Color="Color.Inherit" OnClick="@(() => _isDarkMode = !_isDarkMode)" Class="ml-2" />
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" Elevation="2" Variant="DrawerVariant.Mini"
               OpenMiniOnHover="true" ClipMode="DrawerClipMode.Always">
        <MudNavMenu>
            <MudNavLink Href="/backoffice/dashboard" Icon="@Icons.Material.Filled.Dashboard">
                Dashboard
            </MudNavLink>
            <MudNavLink Href="/backoffice/monitor" Icon="@Icons.Material.Filled.Notifications">
                Monitor
            </MudNavLink>
            <MudDivider Class="my-2" />
            <MudNavLink Href="/backoffice/reminders" Icon="@Icons.Material.Filled.EventRepeat">
                Recordatorios
            </MudNavLink>
            <MudNavLink Href="/backoffice/gastos" Icon="@Icons.Material.Filled.Receipt">
                Gastos
            </MudNavLink>
            <MudNavLink Href="/backoffice/proyectos" Icon="@Icons.Material.Filled.Folder">
                Proyectos
            </MudNavLink>
            <MudNavLink Href="/backoffice/credenciales" Icon="@Icons.Material.Filled.VpnKey">
                Contrase√±as
            </MudNavLink>
            <MudNavLink Href="/backoffice/prompts" Icon="@Icons.Material.Filled.Chat">
                Prompts
            </MudNavLink>
            <MudDivider Class="my-2" />
            <MudNavLink Href="/backoffice/usuarios" Icon="@Icons.Material.Filled.People">
                Usuarios
            </MudNavLink>
            <MudNavLink Href="/backoffice/tools" Icon="@Icons.Material.Filled.Build">
                Herramientas
            </MudNavLink>
            <MudNavLink Href="/backoffice/tags" Icon="@Icons.Material.Filled.Label">
                Tags
            </MudNavLink>
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code {
    private MudThemeProvider _themeProvider = default!;
    private bool _isDarkMode = false;
    private bool _drawerOpen = true;

    private readonly MudTheme _customTheme = new()
    {
        PaletteLight = new PaletteLight
        {
            Primary = "#04787C",
            PrimaryDarken = "#236668",
            PrimaryLighten = "#07ABB0",
            AppbarBackground = "#04787C"
        },
        PaletteDark = new PaletteDark
        {
            Primary = "#07ABB0", // Lighten for dark mode
            PrimaryDarken = "#04787C",
            PrimaryLighten = "#236668",
            AppbarBackground = "#1E1E1E" // Keep dark for dark mode appbar or match primary if preferred. defaulting to standard dark.
        }
    };

    protected override void OnInitialized()
    {
        CheckAuthentication();
        Navigation.LocationChanged += OnLocationChanged;
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await InvokeAsync(() =>
        {
            CheckAuthentication();
            StateHasChanged();
        });
    }

    private void CheckAuthentication()
    {
        var uri = new Uri(Navigation.Uri);
        var isBackofficePath = uri.AbsolutePath.StartsWith("/backoffice", StringComparison.OrdinalIgnoreCase);

        if (isBackofficePath && !CurrentUser.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isDarkMode = await _themeProvider.GetSystemPreference();
            StateHasChanged();
        }
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
