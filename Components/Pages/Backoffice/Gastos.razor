@page "/backoffice/gastos"
@using JSCHUB.Application.DTOs
@using JSCHUB.Application.Interfaces
@using JSCHUB.Domain.Enums
@rendermode InteractiveServer

<PageTitle>Gastos - JSCHUB</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">
            <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" />
            Gastos
        </MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   Href="/backoffice/gastos/new"
                   Disabled="@(!_puedeCrear)">
            Nuevo Gasto
        </MudButton>
    </div>

    <!-- Filtros -->
    <MudPaper Class="pa-3 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="2">
                <MudTextField @bind-Value="_searchText" Label="Buscar"
                              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                              Variant="Variant.Outlined" Dense="true"
                              DebounceInterval="300" OnDebounceIntervalElapsed="@(async () => await LoadDataAsync())" />
            </MudItem>
            <MudItem xs="6" sm="2">
                <MudSelect T="Guid?" @bind-Value="_filterProyectoId" Label="Proyecto" Clearable="true"
                           Variant="Variant.Outlined" Dense="true">
                    @foreach (var proyecto in _proyectosUsuario)
                    {
                        <MudSelectItem Value="@((Guid?)proyecto.Id)">
                            @(proyecto.EsGeneral ? " General" : proyecto.Nombre)
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="6" sm="2">
                <MudSelect T="Guid?" @bind-Value="_filterPagadoPorId" Label="Pagado por" Clearable="true"
                           Variant="Variant.Outlined" Dense="true">
                    @foreach (var usuario in _usuarios)
                    {
                        <MudSelectItem Value="@((Guid?)usuario.Id)">@usuario.Nombre</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="6" sm="2">
                <MudDatePicker @bind-Date="_filterFechaDesde" Label="Desde"
                               Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true" />
            </MudItem>
            <MudItem xs="6" sm="2">
                <MudDatePicker @bind-Date="_filterFechaHasta" Label="Hasta"
                               Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true" />
            </MudItem>
            <MudItem xs="6" sm="1">
                <MudSelect T="EstadoGasto?" @bind-Value="_filterEstado" Label="Estado" Clearable="true"
                           Variant="Variant.Outlined" Dense="true">
                    <MudSelectItem Value="@((EstadoGasto?)EstadoGasto.Previsto)">Previsto</MudSelectItem>
                    <MudSelectItem Value="@((EstadoGasto?)EstadoGasto.Pendiente)">Pendiente</MudSelectItem>
                    <MudSelectItem Value="@((EstadoGasto?)EstadoGasto.Pagado)">Pagado</MudSelectItem>
                    <MudSelectItem Value="@((EstadoGasto?)EstadoGasto.Saldado)">Saldado</MudSelectItem>
                    <MudSelectItem Value="@((EstadoGasto?)EstadoGasto.PendienteDevolucion)">Pte. Devoluci贸n</MudSelectItem>
                    <MudSelectItem Value="@((EstadoGasto?)EstadoGasto.Anulado)">Anulado</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="1" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadDataAsync"
                           StartIcon="@Icons.Material.Filled.Search" FullWidth="true">
                    Filtrar
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Resultados -->
    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudText Typo="Typo.body2" Class="mb-2 mud-text-secondary">
            Mostrando @_gastos.Count de @_totalCount resultados
            @if (_gastos.Any())
            {
                <text> 路 Total: <strong>@_gastos.Sum(g => g.Importe).ToString("N2") @_gastos.FirstOrDefault()?.Moneda</strong></text>
            }
        </MudText>

        <MudTable Items="_gastos" Hover="true" Striped="true" Elevation="2">
            <HeaderContent>
                <MudTh>Fecha</MudTh>
                <MudTh>Concepto</MudTh>
                <MudTh>Proyecto</MudTh>
                <MudTh Style="text-align: right">Importe</MudTh>
                <MudTh>Pagado por</MudTh>
                <MudTh>Estado</MudTh>
                <MudTh Style="width: 140px">Acciones</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <div>@context.FechaPago.ToString("dd/MM/yyyy")</div>
                    <div class="mud-text-secondary" style="font-size: 0.85em">@context.HoraPago.ToString("HH:mm")</div>
                </MudTd>
                <MudTd>
                    <MudLink Href="@($"/backoffice/gastos/{context.Id}")">@context.Concepto</MudLink>
                    @if (!string.IsNullOrEmpty(context.Notas))
                    {
                        <div class="mud-text-secondary" style="font-size: 0.85em">@TruncateNotes(context.Notas)</div>
                    }
                </MudTd>
                <MudTd>
                    @if (context.EsGeneral)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                             General
                        </MudChip>
                    }
                    else
                    {
                        @foreach (var proyecto in context.Proyectos.Take(2))
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@proyecto.Nombre</MudChip>
                        }
                        @if (context.Proyectos.Count > 2)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Text">+@(context.Proyectos.Count - 2)</MudChip>
                        }
                    }
                </MudTd>
                <MudTd Style="text-align: right; font-weight: bold">
                    @context.Importe.ToString("N2") @context.Moneda
                </MudTd>
                <MudTd>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                        @context.PagadoPorNombre
                    </MudChip>
                </MudTd>
                <MudTd>
                    <MudChip T="string" Size="Size.Small" Color="@GetEstadoColor(context.Estado)">
                        @GetEstadoLabel(context.Estado)
                    </MudChip>
                </MudTd>
                <MudTd>
                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Visibility"
                                   Href="@($"/backoffice/gastos/{context.Id}")" title="Ver detalle" />
                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Edit"
                                   Href="@($"/backoffice/gastos/{context.Id}/edit")" title="Editar" />
                    @if (context.Estado != EstadoGasto.Anulado)
                    {
                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Cancel"
                                       Color="Color.Warning" title="Anular"
                                       OnClick="@(() => ConfirmAnularAsync(context))" />
                    }
                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Error" title="Eliminar"
                                   OnClick="@(() => ConfirmDeleteAsync(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Class="pa-4">No hay gastos registrados.</MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    }
</MudContainer>

<MudMessageBox @ref="_anularConfirmation" Title="Confirmar anulaci贸n" CancelText="Cancelar">
    <MessageContent>
        驴Est谩s seguro de que deseas anular el gasto <strong>@_gastoToAnular?.Concepto</strong>?
        <br /><br />
        <MudAlert Severity="Severity.Warning" Dense="true">
            El gasto quedar谩 marcado como anulado.
        </MudAlert>
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Cancel">
            Anular
        </MudButton>
    </YesButton>
</MudMessageBox>

<MudMessageBox @ref="_deleteConfirmation" Title="Confirmar eliminaci贸n" CancelText="Cancelar">
    <MessageContent>
        驴Est谩s seguro de que deseas eliminar permanentemente el gasto <strong>@_gastoToDelete?.Concepto</strong>?
        <br /><br />
        <MudAlert Severity="Severity.Error" Dense="true">
            Esta acci贸n no se puede deshacer.
        </MudAlert>
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete">
            Eliminar
        </MudButton>
    </YesButton>
</MudMessageBox>

@code {
    [Inject] private IGastoService GastoService { get; set; } = default!;
    [Inject] private IUsuarioService UsuarioService { get; set; } = default!;
    [Inject] private IUsuarioProyectoService UsuarioProyectoService { get; set; } = default!;
    [Inject] private ICurrentUserService CurrentUserService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    private bool _loading = true;
    private List<GastoDto> _gastos = [];
    private List<UsuarioDto> _usuarios = [];
    private List<ProyectoAsignadoDto> _proyectosUsuario = [];
    private int _totalCount;
    private Guid _usuarioActualId;
    private bool _puedeCrear;

    private string? _searchText;
    private Guid? _filterPagadoPorId;
    private Guid? _filterProyectoId;
    private DateTime? _filterFechaDesde;
    private DateTime? _filterFechaHasta;
    private EstadoGasto? _filterEstado;

    private MudMessageBox _anularConfirmation = default!;
    private MudMessageBox _deleteConfirmation = default!;
    private GastoDto? _gastoToAnular;
    private GastoDto? _gastoToDelete;

    protected override async Task OnInitializedAsync()
    {
        _usuarios = (await UsuarioService.GetAllAsync()).ToList();

        // Obtener usuario actual
        var currentUserName = CurrentUserService.CurrentUserName;
        if (!string.IsNullOrEmpty(currentUserName))
        {
            var usuario = await UsuarioService.GetByNombreAsync(currentUserName);
            if (usuario != null)
            {
                _usuarioActualId = usuario.Id;
                _proyectosUsuario = (await UsuarioProyectoService.GetProyectosDelUsuarioAsync(_usuarioActualId)).ToList();
                _puedeCrear = _proyectosUsuario.Any(p => p.Rol != Domain.Enums.RolProyecto.Viewer);
            }
        }

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        if (_usuarioActualId == Guid.Empty)
        {
            _loading = false;
            return;
        }

        _loading = true;
        try
        {
            var fechaDesde = _filterFechaDesde.HasValue ? DateOnly.FromDateTime(_filterFechaDesde.Value) : (DateOnly?)null;
            var fechaHasta = _filterFechaHasta.HasValue ? DateOnly.FromDateTime(_filterFechaHasta.Value) : (DateOnly?)null;

            _gastos = (await GastoService.SearchAsync(
                usuarioActualId: _usuarioActualId,
                searchText: _searchText,
                pagadoPorId: _filterPagadoPorId,
                fechaDesde: fechaDesde,
                fechaHasta: fechaHasta,
                estado: _filterEstado,
                proyectoId: _filterProyectoId,
                take: 100)).ToList();

            _totalCount = await GastoService.CountAsync(
                usuarioActualId: _usuarioActualId,
                searchText: _searchText,
                pagadoPorId: _filterPagadoPorId,
                fechaDesde: fechaDesde,
                fechaHasta: fechaHasta,
                estado: _filterEstado,
                proyectoId: _filterProyectoId);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ConfirmAnularAsync(GastoDto gasto)
    {
        _gastoToAnular = gasto;
        var result = await _anularConfirmation.ShowAsync();
        if (result == true)
        {
            try
            {
                await GastoService.AnularAsync(_usuarioActualId, gasto.Id);
                Snackbar.Add("Gasto anulado", MudBlazor.Severity.Warning);
                await LoadDataAsync();
            }
            catch (UnauthorizedAccessException ex)
            {
                Snackbar.Add(ex.Message, MudBlazor.Severity.Error);
            }
        }
        _gastoToAnular = null;
    }

    private async Task ConfirmDeleteAsync(GastoDto gasto)
    {
        _gastoToDelete = gasto;
        var result = await _deleteConfirmation.ShowAsync();
        if (result == true)
        {
            try
            {
                await GastoService.DeleteAsync(_usuarioActualId, gasto.Id);
                Snackbar.Add("Gasto eliminado", MudBlazor.Severity.Success);
                await LoadDataAsync();
            }
            catch (UnauthorizedAccessException ex)
            {
                Snackbar.Add(ex.Message, MudBlazor.Severity.Error);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", MudBlazor.Severity.Error);
            }
        }
        _gastoToDelete = null;
    }

    private static string TruncateNotes(string notes) =>
        notes.Length > 50 ? notes[..50] + "..." : notes;

    private static Color GetEstadoColor(EstadoGasto estado) => estado switch
    {
        EstadoGasto.Previsto => Color.Info,
        EstadoGasto.Pendiente => Color.Warning,
        EstadoGasto.Pagado => Color.Success,
        EstadoGasto.Saldado => Color.Primary,
        EstadoGasto.PendienteDevolucion => Color.Secondary,
        EstadoGasto.Anulado => Color.Default,
        _ => Color.Default
    };

    private static string GetEstadoLabel(EstadoGasto estado) => estado switch
    {
        EstadoGasto.Previsto => "Previsto",
        EstadoGasto.Pendiente => "Pendiente",
        EstadoGasto.Pagado => "Pagado",
        EstadoGasto.Saldado => "Saldado",
        EstadoGasto.PendienteDevolucion => "Pte. Devoluci贸n",
        EstadoGasto.Anulado => "Anulado",
        _ => estado.ToString()
    };
}
