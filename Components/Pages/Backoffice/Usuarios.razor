@page "/backoffice/usuarios"
@using JSCHUB.Application.DTOs
@using JSCHUB.Application.Interfaces
@rendermode InteractiveServer

<PageTitle>Usuarios - JSCHUB</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">
            <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
            Usuarios
        </MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   Href="/backoffice/usuarios/new">
            Nuevo Usuario
        </MudButton>
    </div>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudTable Items="_usuarios" Hover="true" Striped="true" Elevation="2">
            <HeaderContent>
                <MudTh>Nombre</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Teléfono</MudTh>
                <MudTh>Estado</MudTh>
                <MudTh Style="width: 180px">Acciones</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudText Typo="Typo.body1" Class="font-weight-bold">@context.Nombre</MudText>
                </MudTd>
                <MudTd>
                    @if (!string.IsNullOrEmpty(context.Email))
                    {
                        <MudLink Href="@($"mailto:{context.Email}")">@context.Email</MudLink>
                    }
                    else
                    {
                        <span class="mud-text-secondary">-</span>
                    }
                </MudTd>
                <MudTd>
                    @if (!string.IsNullOrEmpty(context.Telefono))
                    {
                        <MudLink Href="@($"tel:{context.Telefono}")">@context.Telefono</MudLink>
                    }
                    else
                    {
                        <span class="mud-text-secondary">-</span>
                    }
                </MudTd>
                <MudTd>
                    @if (context.Activo)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Activo</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default">Inactivo</MudChip>
                    }
                </MudTd>
                <MudTd>
                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Edit"
                                   Href="@($"/backoffice/usuarios/{context.Id}/edit")"
                                   Title="Editar" />
                    @if (context.Activo)
                    {
                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.PersonOff"
                                       Color="Color.Warning" Title="Desactivar"
                                       OnClick="@(() => ToggleActivoAsync(context.Id))" />
                    }
                    else
                    {
                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.PersonAdd"
                                       Color="Color.Success" Title="Activar"
                                       OnClick="@(() => ToggleActivoAsync(context.Id))" />
                    }
                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Error" Title="Eliminar"
                                   OnClick="@(() => ConfirmDeleteAsync(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Class="pa-4">No hay usuarios registrados.</MudText>
            </NoRecordsContent>
        </MudTable>
    }
</MudContainer>

<MudMessageBox @ref="_deleteConfirmation" Title="Confirmar eliminación" CancelText="Cancelar">
    <MessageContent>
        ¿Estás seguro de que deseas eliminar al usuario <strong>@_usuarioToDelete?.Nombre</strong>?
        <br /><br />
        <MudAlert Severity="Severity.Warning" Dense="true">
            Esta acción no se puede deshacer.
        </MudAlert>
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete">
            Eliminar
        </MudButton>
    </YesButton>
</MudMessageBox>

@code {
    [Inject] private IUsuarioService UsuarioService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    private bool _loading = true;
    private List<UsuarioDto> _usuarios = [];
    private MudMessageBox _deleteConfirmation = default!;
    private UsuarioDto? _usuarioToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        try
        {
            _usuarios = (await UsuarioService.GetAllAsync()).ToList();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ToggleActivoAsync(Guid id)
    {
        await UsuarioService.ToggleActivoAsync(id);
        var usuario = _usuarios.First(u => u.Id == id);
        var estado = usuario.Activo ? "desactivado" : "activado";
        Snackbar.Add($"Usuario {estado}", MudBlazor.Severity.Success);
        await LoadDataAsync();
    }

    private async Task ConfirmDeleteAsync(UsuarioDto usuario)
    {
        _usuarioToDelete = usuario;
        var result = await _deleteConfirmation.ShowAsync();
        if (result == true)
        {
            await DeleteAsync(usuario.Id);
        }
        _usuarioToDelete = null;
    }

    private async Task DeleteAsync(Guid id)
    {
        try
        {
            await UsuarioService.DeleteAsync(id);
            Snackbar.Add("Usuario eliminado", MudBlazor.Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", MudBlazor.Severity.Error);
        }
    }
}
