@using JSCHUB.Application.DTOs
@using JSCHUB.Application.Interfaces

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Key" />
            <MudText Typo="Typo.h6">Credenciales - @EnlaceTitulo</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.caption" Class="mb-4">@EnlaceUrl</MudText>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else
        {
            @* Lista de credenciales existentes *@
            @if (_credenciales.Any())
            {
                <MudTable Items="_credenciales" Hover="true" Dense="true" Striped="true" Elevation="0">
                    <HeaderContent>
                        <MudTh>Nombre</MudTh>
                        <MudTh>Usuario</MudTh>
                        <MudTh>Estado</MudTh>
                        <MudTh>Acciones</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Nombre">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.VpnKey" Size="Size.Small" Color="Color.Primary" />
                                <MudText>@context.Nombre</MudText>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Usuario">
                            <MudText>@context.Usuario</MudText>
                        </MudTd>
                        <MudTd DataLabel="Estado">
                            @if (context.Activa)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Activa</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">Inactiva</MudChip>
                            }
                        </MudTd>
                        <MudTd DataLabel="Acciones">
                            <MudStack Row="true" Spacing="0">
                                <MudTooltip Text="Copiar contraseña">
                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   OnClick="@(() => CopyPasswordAsync(context.Id))" />
                                </MudTooltip>
                                <MudTooltip Text="Ver detalles">
                                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                   Size="Size.Small"
                                                   Color="Color.Info"
                                                   OnClick="@(() => ShowPasswordAsync(context.Id))" />
                                </MudTooltip>
                                <MudTooltip Text="Editar">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                   Size="Size.Small"
                                                   Color="Color.Warning"
                                                   OnClick="@(() => OpenFormDialog(context))" />
                                </MudTooltip>
                                <MudTooltip Text="Eliminar">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   OnClick="@(() => DeleteCredencialAsync(context.Id))" />
                                </MudTooltip>
                            </MudStack>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mb-4">
                    No hay credenciales registradas para este enlace.
                </MudAlert>
            }

            @* Formulario para nueva/editar credencial *@
            @if (_showForm)
            {
                <MudPaper Class="pa-4 mt-4" Outlined="true">
                    <MudText Typo="Typo.subtitle1" Class="mb-3">
                        @(_editingCredencial == null ? "Nueva credencial" : "Editar credencial")
                    </MudText>
                    <MudForm @ref="_form" @bind-IsValid="_formValid">
                        <MudGrid>
                            <MudItem xs="12" sm="6">
                                <MudTextField T="string"
                                              @bind-Value="_nombre"
                                              Label="Nombre *"
                                              Required="true"
                                              RequiredError="El nombre es obligatorio"
                                              MaxLength="100"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField T="string"
                                              @bind-Value="_usuario"
                                              Label="Usuario *"
                                              Required="true"
                                              RequiredError="El usuario es obligatorio"
                                              MaxLength="500"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField T="string"
                                              @bind-Value="_password"
                                              Label="@(_editingCredencial == null ? "Contraseña *" : "Nueva contraseña")"
                                              Required="@(_editingCredencial == null)"
                                              RequiredError="La contraseña es obligatoria"
                                              MaxLength="1000"
                                              InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense"
                                              Adornment="Adornment.End"
                                              AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                              OnAdornmentClick="@(() => _showPassword = !_showPassword)" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                @if (_editingCredencial != null)
                                {
                                    <MudSwitch T="bool" @bind-Value="_activa" Label="Credencial activa" Color="Color.Primary" />
                                }
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField T="string"
                                              @bind-Value="_notas"
                                              Label="Notas"
                                              MaxLength="2000"
                                              Lines="2"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense" />
                            </MudItem>
                        </MudGrid>
                        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-3">
                            <MudButton OnClick="CloseFormDialog" Variant="Variant.Text">Cancelar</MudButton>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Disabled="@(!_formValid || _saving)"
                                       OnClick="SaveCredencialAsync">
                                @if (_saving)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                }
                                Guardar
                            </MudButton>
                        </MudStack>
                    </MudForm>
                </MudPaper>
            }
        }
    </DialogContent>
    <DialogActions>
        @if (!_showForm)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@(() => OpenFormDialog())">
                Nueva credencial
            </MudButton>
        }
        <MudButton OnClick="Cancel">Cerrar</MudButton>
    </DialogActions>
</MudDialog>

@* Dialog para mostrar contraseña *@
<MudDialog @bind-Visible="_showPasswordDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">Detalles de credencial</MudText>
    </TitleContent>
    <DialogContent>
        @if (_credencialDetalle != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.caption">Nombre</MudText>
                    <MudText Typo="Typo.body1">@_credencialDetalle.Nombre</MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.caption">Usuario</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body1">@_credencialDetalle.Usuario</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                       Size="Size.Small"
                                       OnClick="@(() => CopyToClipboard(_credencialDetalle.Usuario, "Usuario copiado"))" />
                    </MudStack>
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.caption">Contraseña</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body1" Style="font-family: monospace;">
                            @(_showPasswordInDialog ? _credencialDetalle.Password : new string('*', 12))
                        </MudText>
                        <MudIconButton Icon="@(_showPasswordInDialog ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                       Size="Size.Small"
                                       OnClick="@(() => _showPasswordInDialog = !_showPasswordInDialog)" />
                        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                       Size="Size.Small"
                                       OnClick="@(() => CopyToClipboard(_credencialDetalle.Password, "Contraseña copiada"))" />
                    </MudStack>
                </MudItem>
                @if (!string.IsNullOrWhiteSpace(_credencialDetalle.Notas))
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.caption">Notas</MudText>
                        <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@_credencialDetalle.Notas</MudText>
                    </MudItem>
                }
                @if (_credencialDetalle.UltimoAcceso.HasValue)
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Ultimo acceso: @_credencialDetalle.UltimoAcceso.Value.ToString("dd/MM/yyyy HH:mm")
                        </MudText>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => { _showPasswordDialog = false; _showPasswordInDialog = false; })">Cerrar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public Guid EnlaceId { get; set; }
    [Parameter] public string EnlaceTitulo { get; set; } = string.Empty;
    [Parameter] public string EnlaceUrl { get; set; } = string.Empty;

    [Inject] private ICredencialProyectoService CredencialService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    private bool _loading = true;
    private List<CredencialProyectoDto> _credenciales = new();

    // Form
    private bool _showForm;
    private MudForm? _form;
    private bool _formValid;
    private bool _saving;
    private CredencialProyectoDto? _editingCredencial;
    private string _nombre = string.Empty;
    private string _usuario = string.Empty;
    private string _password = string.Empty;
    private string? _notas;
    private bool _activa = true;
    private bool _showPassword;

    // Password dialog
    private bool _showPasswordDialog;
    private bool _showPasswordInDialog;
    private CredencialProyectoConPasswordDto? _credencialDetalle;

    protected override async Task OnInitializedAsync()
    {
        await LoadCredencialesAsync();
    }

    private async Task LoadCredencialesAsync()
    {
        _loading = true;
        try
        {
            var result = await CredencialService.GetByEnlaceIdAsync(EnlaceId);
            _credenciales = result.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar credenciales: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OpenFormDialog(CredencialProyectoDto? credencial = null)
    {
        _editingCredencial = credencial;
        if (credencial != null)
        {
            _nombre = credencial.Nombre;
            _usuario = credencial.Usuario;
            _password = string.Empty; // No mostramos la contraseña actual
            _notas = credencial.Notas;
            _activa = credencial.Activa;
        }
        else
        {
            _nombre = string.Empty;
            _usuario = string.Empty;
            _password = string.Empty;
            _notas = null;
            _activa = true;
        }
        _showPassword = false;
        _showForm = true;
    }

    private void CloseFormDialog()
    {
        _showForm = false;
        _editingCredencial = null;
    }

    private async Task SaveCredencialAsync()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_formValid) return;
        }

        _saving = true;
        try
        {
            if (_editingCredencial == null)
            {
                var dto = new CreateCredencialProyectoDto(
                    EnlaceProyectoId: EnlaceId,
                    Nombre: _nombre,
                    Usuario: _usuario,
                    Password: _password,
                    Notas: _notas);
                await CredencialService.CreateAsync(dto, "usuario");
                Snackbar.Add("Credencial creada correctamente", Severity.Success);
            }
            else
            {
                var dto = new UpdateCredencialProyectoDto(
                    Nombre: _nombre,
                    Usuario: _usuario,
                    Password: string.IsNullOrEmpty(_password) ? null : _password,
                    Notas: _notas,
                    Activa: _activa);
                await CredencialService.UpdateAsync(_editingCredencial.Id, dto, "usuario");
                Snackbar.Add("Credencial actualizada correctamente", Severity.Success);
            }

            CloseFormDialog();
            await LoadCredencialesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task DeleteCredencialAsync(Guid id)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirmar eliminacion",
            "¿Esta seguro de que desea eliminar esta credencial? Esta accion no se puede deshacer.",
            yesText: "Eliminar",
            cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                await CredencialService.DeleteAsync(id);
                Snackbar.Add("Credencial eliminada", Severity.Warning);
                await LoadCredencialesAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al eliminar: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task CopyPasswordAsync(Guid id)
    {
        try
        {
            var password = await CredencialService.GetPasswordAsync(id, "usuario");
            await CopyToClipboard(password, "Contraseña copiada al portapapeles");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al copiar: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowPasswordAsync(Guid id)
    {
        try
        {
            _credencialDetalle = await CredencialService.GetByIdWithPasswordAsync(id, "usuario");
            _showPasswordInDialog = false;
            _showPasswordDialog = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al obtener detalles: {ex.Message}", Severity.Error);
        }
    }

    private async Task CopyToClipboard(string text, string message)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
            Snackbar.Add(message, Severity.Success);
        }
        catch
        {
            Snackbar.Add("No se pudo copiar al portapapeles", Severity.Warning);
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
