@using JSCHUB.Application.DTOs
@using JSCHUB.Application.Interfaces

<MudDialog ActionsClass="px-6 pb-6">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Key" Color="Color.Primary" />
                <MudText Typo="Typo.h6">
                    @(_mode == ViewMode.List ? $"Credenciales - {EnlaceTitulo}" : 
                      _mode == ViewMode.Form ? (_editingCredencial == null ? "Nueva credencial" : "Editar credencial") :
                      "Detalles de credencial")
                </MudText>
            </MudStack>
            @if (_mode != ViewMode.List)
            {
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                               Color="Color.Inherit" 
                               OnClick="GoBack" />
            }
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_mode != ViewMode.Form || EnlacesDisponibles == null || !EnlacesDisponibles.Any())
        {
            <MudText Typo="Typo.caption" Class="mb-4 d-block">@_currentEnlaceUrl</MudText>
        }

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else
        {
            @if (_mode == ViewMode.List)
            {
                @* MODO LISTA *@
                @if (_credenciales.Any())
                {
                    <MudTable Items="_credenciales" Hover="true" Dense="true" Striped="true" Elevation="0" Class="mt-2">
                        <HeaderContent>
                            <MudTh>Nombre</MudTh>
                            <MudTh>Usuario</MudTh>
                            <MudTh>Estado</MudTh>
                            <MudTh>Acciones</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Nombre">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.VpnKey" Size="Size.Small" Color="Color.Primary" />
                                    <MudText>@context.Nombre</MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Usuario">
                                <MudText>@context.Usuario</MudText>
                            </MudTd>
                            <MudTd DataLabel="Estado">
                                @if (context.Activa)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Activa</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">Inactiva</MudChip>
                                }
                            </MudTd>
                            <MudTd DataLabel="Acciones">
                                <MudStack Row="true" Spacing="0">
                                    <MudTooltip Text="Copiar contraseña">
                                        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                                       Size="Size.Small"
                                                       Color="Color.Primary"
                                                       OnClick="@(() => CopyPasswordAsync(context.Id))" />
                                    </MudTooltip>
                                    <MudTooltip Text="Ver detalles">
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                       Size="Size.Small"
                                                       Color="Color.Info"
                                                       OnClick="@(() => ShowDetailsAsync(context.Id))" />
                                    </MudTooltip>
                                    <MudTooltip Text="Editar">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                       Size="Size.Small"
                                                       Color="Color.Warning"
                                                       OnClick="@(() => OpenForm(context))" />
                                    </MudTooltip>
                                    <MudTooltip Text="Eliminar">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                       Size="Size.Small"
                                                       Color="Color.Error"
                                                       OnClick="@(() => DeleteCredencialAsync(context.Id))" />
                                    </MudTooltip>
                                </MudStack>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        No hay credenciales registradas para este enlace.
                    </MudAlert>
                }
            }
            else if (_mode == ViewMode.Form)
            {
                @* MODO FORMULARIO (CREAR/EDITAR) *@
                <MudForm @ref="_form" @bind-IsValid="_formValid">
                    <MudGrid>
                        @if (EnlacesDisponibles != null && EnlacesDisponibles.Any())
                        {
                            <MudItem xs="12">
                                <MudSelect T="Guid" Label="Vincular con enlace" @bind-Value="EnlaceId" Variant="Variant.Outlined" Margin="Margin.Dense">
                                    @foreach (var enlace in EnlacesDisponibles)
                                    {
                                        <MudSelectItem Value="@enlace.Id">@enlace.Titulo (@enlace.Url)</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                        }

                        <MudItem xs="12" sm="6">
                            <MudTextField T="string"
                                          @bind-Value="_nombre"
                                          Label="Nombre *"
                                          Required="true"
                                          RequiredError="El nombre es obligatorio"
                                          MaxLength="100"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField T="string"
                                          @bind-Value="_usuario"
                                          Label="Usuario *"
                                          Required="true"
                                          RequiredError="El usuario es obligatorio"
                                          MaxLength="500"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense" />
                        </MudItem>
                        <MudItem xs="12" sm="@( _editingCredencial == null ? 12 : 6)">
                            <MudTextField T="string"
                                          @bind-Value="_password"
                                          Label="@(_editingCredencial == null ? "Contraseña *" : "Nueva contraseña (dejar vacío para no cambiar)")"
                                          Required="@(_editingCredencial == null)"
                                          RequiredError="La contraseña es obligatoria"
                                          MaxLength="1000"
                                          InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Adornment="Adornment.End"
                                          AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                          OnAdornmentClick="@(() => _showPassword = !_showPassword)" />
                        </MudItem>
                        @if (_editingCredencial != null)
                        {
                            <MudItem xs="12" sm="6" Class="d-flex align-center">
                                <MudSwitch T="bool" @bind-Value="_activa" Label="Credencial activa" Color="Color.Primary" />
                            </MudItem>
                        }
                        <MudItem xs="12">
                            <MudTextField T="string"
                                          @bind-Value="_notas"
                                          Label="Notas"
                                          Placeholder="Escribe aquí notas adicionales..."
                                          MaxLength="2000"
                                          Lines="3"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense" />
                        </MudItem>
                    </MudGrid>
                </MudForm>
            }
            else if (_mode == ViewMode.Details)
            {
                @* MODO DETALLES *@
                @if (_credencialDetalle != null)
                {
                    <MudPaper Class="pa-4" Elevation="0" Outlined="true">
                        <MudGrid>
                            <MudItem xs="12" sm="6">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Nombre</MudText>
                                <MudText Typo="Typo.body1">@_credencialDetalle.Nombre</MudText>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Usuario</MudText>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.body1">@_credencialDetalle.Usuario</MudText>
                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                                   Size="Size.Small"
                                                   OnClick="@(() => CopyToClipboard(_credencialDetalle.Usuario, "Usuario copiado"))" />
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Contraseña</MudText>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.body1" Style="font-family: 'Roboto Mono', monospace; font-weight: 500;">
                                        @(_showPasswordInDetails ? _credencialDetalle.Password : "••••••••••••")
                                    </MudText>
                                    <MudIconButton Icon="@(_showPasswordInDetails ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                                   Size="Size.Small"
                                                   OnClick="@(() => _showPasswordInDetails = !_showPasswordInDetails)" />
                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                                   Size="Size.Small"
                                                   OnClick="@(() => CopyToClipboard(_credencialDetalle.Password, "Contraseña copiada"))" />
                                </MudStack>
                            </MudItem>
                            @if (!string.IsNullOrWhiteSpace(_credencialDetalle.Notas))
                            {
                                <MudItem xs="12">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Notas</MudText>
                                    <MudText Typo="Typo.body2" Style="white-space: pre-wrap;" Class="pa-2 grey lighten-4 rounded">@_credencialDetalle.Notas</MudText>
                                </MudItem>
                            }
                            @if (_credencialDetalle.UltimoAcceso.HasValue)
                            {
                                <MudItem xs="12">
                                    <MudDivider Class="my-2" />
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Último acceso a la contraseña: <MudText Inline="true" Typo="Typo.caption" Color="Color.Default">@_credencialDetalle.UltimoAcceso.Value.ToString("dd/MM/yyyy HH:mm")</MudText>
                                    </MudText>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudPaper>
                }
                else
                {
                    <MudProgressCircular Indeterminate="true" />
                }
            }
        }
    </DialogContent>
    <DialogActions>
        @if (_mode == ViewMode.List)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@(() => OpenForm())">
                Nueva credencial
            </MudButton>
            <MudButton OnClick="Cancel">Cerrar</MudButton>
        }
        else if (_mode == ViewMode.Form)
        {
            <MudButton OnClick="GoBack" Variant="Variant.Text">Cancelar</MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@(!_formValid || _saving)"
                       OnClick="SaveCredencialAsync">
                @if (_saving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Guardar
            </MudButton>
        }
        else if (_mode == ViewMode.Details)
        {
            <MudButton OnClick="GoBack" Variant="Variant.Filled" Color="Color.Default">Volver</MudButton>
            <MudButton OnClick="Cancel">Cerrar</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public Guid EnlaceId { get; set; }
    [Parameter] public string EnlaceTitulo { get; set; } = string.Empty;
    [Parameter] public string EnlaceUrl { get; set; } = string.Empty;
    [Parameter] public List<EnlaceProyectoDto>? EnlacesDisponibles { get; set; }
    [Parameter] public Guid? InitialCredencialId { get; set; }
    [Parameter] public bool StartInFormMode { get; set; }

    [Inject] private ICredencialProyectoService CredencialService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    private enum ViewMode { List, Form, Details }
    private ViewMode _mode = ViewMode.List;

    private bool _loading = true;
    private List<CredencialProyectoDto> _credenciales = new();

    // Form
    private MudForm? _form;
    private bool _formValid;
    private bool _saving;
    private CredencialProyectoDto? _editingCredencial;
    private string _nombre = string.Empty;
    private string _usuario = string.Empty;
    private string _password = string.Empty;
    private string? _notas;
    private bool _activa = true;
    private bool _showPassword;

    // Details Mode
    private bool _showPasswordInDetails;
    private CredencialProyectoConPasswordDto? _credencialDetalle;
    
    // Dynamic URL based on selected enlace
    private string _currentEnlaceUrl => EnlacesDisponibles?.FirstOrDefault(e => e.Id == EnlaceId)?.Url ?? EnlaceUrl;

    protected override async Task OnInitializedAsync()
    {
        await LoadCredencialesAsync();
        
        if (InitialCredencialId.HasValue)
        {
            await ShowDetailsAsync(InitialCredencialId.Value);
        }
        else if (StartInFormMode)
        {
            OpenForm();
        }
    }

    private async Task LoadCredencialesAsync()
    {
        _loading = true;
        try
        {
            var result = await CredencialService.GetByEnlaceIdAsync(EnlaceId);
            _credenciales = result.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar credenciales: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OpenForm(CredencialProyectoDto? credencial = null)
    {
        _editingCredencial = credencial;
        if (credencial != null)
        {
            _nombre = credencial.Nombre;
            _usuario = credencial.Usuario;
            _password = string.Empty; 
            _notas = credencial.Notas;
            _activa = credencial.Activa;
        }
        else
        {
            _nombre = string.Empty;
            _usuario = string.Empty;
            _password = string.Empty;
            _notas = null;
            _activa = true;
        }
        _showPassword = false;
        _mode = ViewMode.Form;
    }

    private async Task ShowDetailsAsync(Guid id)
    {
        _loading = true;
        _mode = ViewMode.Details;
        _showPasswordInDetails = false;
        try
        {
            _credencialDetalle = await CredencialService.GetByIdWithPasswordAsync(id, "sistema");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al obtener detalles: {ex.Message}", Severity.Error);
            _mode = ViewMode.List;
        }
        finally
        {
            _loading = false;
        }
    }

    private void GoBack()
    {
        // Si se abrió directamente en formulario, cancelar cierra el diálogo
        if (StartInFormMode && _mode == ViewMode.Form)
        {
            Cancel();
            return;
        }
        
        _mode = ViewMode.List;
        _editingCredencial = null;
    }

    private async Task SaveCredencialAsync()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_formValid) return;
        }

        _saving = true;
        try
        {
            if (_editingCredencial == null)
            {
                var dto = new CreateCredencialProyectoDto(
                    EnlaceProyectoId: EnlaceId,
                    Nombre: _nombre,
                    Usuario: _usuario,
                    Password: _password,
                    Notas: _notas);
                await CredencialService.CreateAsync(dto, "sistema");
                Snackbar.Add("Credencial creada correctamente", Severity.Success);
            }
            else
            {
                var dto = new UpdateCredencialProyectoDto(
                    Nombre: _nombre,
                    Usuario: _usuario,
                    Password: string.IsNullOrEmpty(_password) ? null : _password,
                    Notas: _notas,
                    Activa: _activa);
                await CredencialService.UpdateAsync(_editingCredencial.Id, dto, "sistema");
                Snackbar.Add("Credencial actualizada correctamente", Severity.Success);
            }

            _mode = ViewMode.List;
            await LoadCredencialesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task DeleteCredencialAsync(Guid id)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirmar eliminación",
            "¿Está seguro de que desea eliminar esta credencial? Esta acción no se puede deshacer.",
            yesText: "Eliminar",
            cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                await CredencialService.DeleteAsync(id);
                Snackbar.Add("Credencial eliminada", Severity.Warning);
                await LoadCredencialesAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al eliminar: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task CopyPasswordAsync(Guid id)
    {
        try
        {
            var password = await CredencialService.GetPasswordAsync(id, "sistema");
            await CopyToClipboard(password, "Contraseña copiada al portapapeles");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al copiar: {ex.Message}", Severity.Error);
        }
    }

    private async Task CopyToClipboard(string text, string message)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
            Snackbar.Add(message, Severity.Success);
        }
        catch
        {
            Snackbar.Add("No se pudo copiar al portapapeles", Severity.Warning);
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
