@page "/backoffice/gastos/new"
@page "/backoffice/gastos/{Id:guid}/edit"
@using JSCHUB.Application.DTOs
@using JSCHUB.Application.Interfaces
@using JSCHUB.Domain.Enums
@rendermode InteractiveServer

<PageTitle>@(_isNew ? "Nuevo Gasto" : "Editar Gasto") - JSCHUB</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h5" Class="mb-4">
            <MudIcon Icon="@(_isNew ? Icons.Material.Filled.AddShoppingCart : Icons.Material.Filled.Edit)" Class="mr-2" />
            @(_isNew ? "Nuevo Gasto" : "Editar Gasto")
        </MudText>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else
        {
            <MudForm @ref="_form" @bind-IsValid="_formValid">
                <MudTextField @bind-Value="_concepto" Label="Concepto" Required="true"
                              RequiredError="El concepto es obligatorio"
                              MaxLength="200" Class="mb-3" />

                <MudGrid>
                    <MudItem xs="8">
                        <MudNumericField @bind-Value="_importe" Label="Importe" Required="true"
                                         RequiredError="El importe es obligatorio"
                                         Min="0.01m" Format="N2"
                                         Validation="@(new Func<decimal, string?>(v => v <= 0 ? "El importe debe ser mayor que 0" : null))"
                                         Adornment="Adornment.End" AdornmentText="@_moneda"
                                         Class="mb-3" />
                    </MudItem>
                    <MudItem xs="4">
                        <MudSelect T="string" @bind-Value="_moneda" Label="Moneda" Class="mb-3">
                            <MudSelectItem Value="@("EUR")">EUR</MudSelectItem>
                            <MudSelectItem Value="@("USD")">USD</MudSelectItem>
                            <MudSelectItem Value="@("GBP")">GBP</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                </MudGrid>

                <MudSelect T="Guid" @bind-Value="_pagadoPorId" Label="Pagado por" Required="true"
                           RequiredError="Debe indicar qui√©n pag√≥" Class="mb-3">
                    @foreach (var usuario in _usuarios)
                    {
                        <MudSelectItem Value="@usuario.Id">@usuario.Nombre</MudSelectItem>
                    }
                </MudSelect>

                <MudGrid>
                    <MudItem xs="6">
                        <MudDatePicker @bind-Date="_fechaPago" Label="Fecha de pago" Required="true"
                                       RequiredError="La fecha es obligatoria" Class="mb-3" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTimePicker @bind-Time="_horaPago" Label="Hora de pago" Required="true"
                                       RequiredError="La hora es obligatoria" Class="mb-3" />
                    </MudItem>
                </MudGrid>

                <MudTextField @bind-Value="_notas" Label="Notas" Lines="3"
                              MaxLength="1000" Class="mb-3" />

                <MudSelect T="Guid" @bind-SelectedValues="_selectedProyectoIds" Label="Proyectos"
                           MultiSelection="true" Class="mb-3" Variant="Variant.Outlined"
                           MultiSelectionTextFunc="@(ids => GetProyectosSeleccionadosText(ids))">
                    @foreach (var proyecto in _proyectosUsuario)
                    {
                        <MudSelectItem Value="@proyecto.Id">
                            @(proyecto.EsGeneral ? "üåê General" : proyecto.Nombre)
                        </MudSelectItem>
                    }
                </MudSelect>
                @if (_proyectoGeneralId.HasValue && _selectedProyectoIds.Contains(_proyectoGeneralId.Value) && _selectedProyectoIds.Count() > 1)
                {
                    <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-3">
                        Si selecciona "General", no puede seleccionar otros proyectos.
                    </MudAlert>
                }

                <MudSelect T="EstadoGasto" @bind-Value="_estado" Label="Estado" Class="mb-3">
                    <MudSelectItem Value="@EstadoGasto.Previsto">Previsto</MudSelectItem>
                    <MudSelectItem Value="@EstadoGasto.Pendiente">Pendiente</MudSelectItem>
                    <MudSelectItem Value="@EstadoGasto.Pagado">Pagado</MudSelectItem>
                    <MudSelectItem Value="@EstadoGasto.Saldado">Saldado</MudSelectItem>
                    <MudSelectItem Value="@EstadoGasto.PendienteDevolucion">Pendiente Devoluci√≥n</MudSelectItem>
                    <MudSelectItem Value="@EstadoGasto.Anulado">Anulado</MudSelectItem>
                </MudSelect>

                <div class="d-flex gap-2 mt-4">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               OnClick="SaveAsync" Disabled="@(!_formValid || _saving)">
                        @if (_saving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        Guardar
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Href="/backoffice/gastos">
                        Cancelar
                    </MudButton>
                </div>
            </MudForm>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public Guid? Id { get; set; }

    [Inject] private IGastoService GastoService { get; set; } = default!;
    [Inject] private IUsuarioService UsuarioService { get; set; } = default!;
    [Inject] private IUsuarioProyectoService UsuarioProyectoService { get; set; } = default!;
    [Inject] private ICurrentUserService CurrentUserService { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    private MudForm _form = default!;
    private bool _loading = true;
    private bool _saving;
    private bool _formValid;
    private bool _isNew => !Id.HasValue;

    private List<UsuarioDto> _usuarios = [];
    private List<ProyectoAsignadoDto> _proyectosUsuario = [];
    private Guid _usuarioActualId;
    private Guid? _proyectoGeneralId;

    private string _concepto = string.Empty;
    private string? _notas;
    private decimal _importe;
    private string _moneda = "EUR";
    private Guid _pagadoPorId;
    private DateTime? _fechaPago = DateTime.Today;
    private TimeSpan? _horaPago = DateTime.Now.TimeOfDay;
    private EstadoGasto _estado = EstadoGasto.Previsto;
    private IEnumerable<Guid> _selectedProyectoIds = [];

    protected override async Task OnInitializedAsync()
    {
        _usuarios = (await UsuarioService.GetActivosAsync()).ToList();

        // Obtener usuario actual y sus proyectos
        var currentUserName = CurrentUserService.CurrentUserName;
        if (!string.IsNullOrEmpty(currentUserName))
        {
            var usuario = await UsuarioService.GetByNombreAsync(currentUserName);
            if (usuario != null)
            {
                _usuarioActualId = usuario.Id;
                _proyectosUsuario = (await UsuarioProyectoService.GetProyectosDelUsuarioAsync(_usuarioActualId))
                    .Where(p => p.Rol != Domain.Enums.RolProyecto.Viewer)
                    .ToList();

                var proyectoGeneral = await UsuarioProyectoService.GetProyectoGeneralAsync();
                _proyectoGeneralId = proyectoGeneral?.Id;
            }
        }

        if (!_isNew)
        {
            var gasto = await GastoService.GetByIdAsync(Id!.Value);
            if (gasto == null)
            {
                Snackbar.Add("Gasto no encontrado", MudBlazor.Severity.Error);
                Navigation.NavigateTo("/backoffice/gastos");
                return;
            }

            _concepto = gasto.Concepto;
            _notas = gasto.Notas;
            _importe = gasto.Importe;
            _moneda = gasto.Moneda;
            _pagadoPorId = gasto.PagadoPorId;
            _fechaPago = gasto.FechaPago.ToDateTime(TimeOnly.MinValue);
            _horaPago = gasto.HoraPago.ToTimeSpan();
            _estado = gasto.Estado;
            _selectedProyectoIds = gasto.Proyectos.Select(p => p.Id).ToList();
        }
        else if (_usuarios.Any())
        {
            // Pre-seleccionar el usuario que coincide con el usuario logueado
            var currentUser = CurrentUserService.CurrentUserName;
            var usuarioActual = _usuarios.FirstOrDefault(u =>
                string.Equals(u.Nombre, currentUser, StringComparison.OrdinalIgnoreCase));

            _pagadoPorId = usuarioActual?.Id ?? _usuarios.First().Id;

            // Por defecto, seleccionar Proyecto General si el usuario tiene acceso
            if (_proyectoGeneralId.HasValue && _proyectosUsuario.Any(p => p.EsGeneral))
            {
                _selectedProyectoIds = [_proyectoGeneralId.Value];
            }
        }

        _loading = false;
    }

    private async Task SaveAsync()
    {
        await _form.Validate();
        if (!_formValid) return;

        // Validar que no se mezcle General con otros proyectos
        if (_proyectoGeneralId.HasValue && _selectedProyectoIds.Contains(_proyectoGeneralId.Value) && _selectedProyectoIds.Count() > 1)
        {
            Snackbar.Add("No puede mezclar 'General' con otros proyectos", MudBlazor.Severity.Error);
            return;
        }

        _saving = true;
        try
        {
            var fechaPago = DateOnly.FromDateTime(_fechaPago!.Value);
            var horaPago = TimeOnly.FromTimeSpan(_horaPago!.Value);
            var proyectoIds = _selectedProyectoIds.Any() ? _selectedProyectoIds.ToList() : null;

            if (_isNew)
            {
                var dto = new CreateGastoDto(
                    _concepto, _notas, _importe, _moneda,
                    _pagadoPorId, fechaPago, horaPago, proyectoIds);
                await GastoService.CreateAsync(_usuarioActualId, dto);
                Snackbar.Add("Gasto creado", MudBlazor.Severity.Success);
            }
            else
            {
                var dto = new UpdateGastoDto(
                    _concepto, _notas, _importe, _moneda,
                    _pagadoPorId, fechaPago, horaPago, _estado, proyectoIds);
                await GastoService.UpdateAsync(_usuarioActualId, Id!.Value, dto);
                Snackbar.Add("Gasto actualizado", MudBlazor.Severity.Success);
            }

            Navigation.NavigateTo("/backoffice/gastos");
        }
        catch (UnauthorizedAccessException ex)
        {
            Snackbar.Add(ex.Message, MudBlazor.Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", MudBlazor.Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private string GetProyectosSeleccionadosText(List<string> ids)
    {
        if (!ids.Any()) return "Sin proyectos (se asignar√° a General)";

        var nombres = _proyectosUsuario
            .Where(p => ids.Contains(p.Id.ToString()))
            .Select(p => p.EsGeneral ? "General" : p.Nombre)
            .ToList();

        return string.Join(", ", nombres);
    }
}
